<!DOCTYPE html>
<html>
	<head>
		<title>Twittler: legally distinct from twitter</title>
		<link rel="stylesheet" href="main.css">
	</head>
	<body>
		
		
		<header class="main-header container">
			<h1><img class="logo" src="twittler_logo.png" width="800px" height="166px" alt="Twittler logo with a sad bird"></h1>
			<h3 class="tagline">The Legally Distinct from Twitter Clone</h3>
		</header>
		
		
		<!--the main body, including UI, feed, and overlay -->
		<section class="main">
			<div class="container">
				<section class="input clearfix">
					<input type="text" name="user-message" class="user-message" placeholder="your tweetle">
					<button type="button" class="btn send">Send</button>
					<button type="button" class="btn refresh">Stop Refresh</button>
				</section>
				<section class="secondary clearfix">
					<span class="second-heading">@you's tweetles</span><button type="button" class="btn hide">Hide</button>
					<div class ="second-feed">
						<!--this is where JS makes user specific tweets propagate-->
					</div>
				</section>
				<section class="feed">
					<!--this is where JS makes tweetles propagate-->
				</section>
			</div>
		</section>
	  
	  
		<footer class="main-footer container">
			<section class="copy-notice clearfix">
				&copy; Twittler Inc. <em>(nothing like any other bird themed messaging services)</em>
			</section>
			
			<section class="bird-link">
				<a href="http://www.inflexwetrust.com/2011/11/11/tech-talk-design-twitter-birds-youve-never-seen-before/ifwt-twitter-logo-design-aberthol/"><em>original sad twittler bird by TatWza</em></a>
			</section>
		</footer>
		
		<script src="jquery.js"></script>
		<script src="data_generator.js"></script>
		<script src="moment.js"></script>
		<script>
			$(document).ready(function(){
				var printed = 0; //the most recent main tweetle index to have been printed
				var userPrinted = 0; //counts the tweetle index of the currently displayed user
				var refresh = true; //whether or not the user wishes to see new tweetles
				var paused = false; //whether a mouse hover is currently being used to pause refreshes
				var user = ""; //current user in the overlay
				
				//global timer objects prevent bug caused by multiple timers being created
				var timer = undefined; 
				var overlayTimer = undefined;
				
				//I couldn't figure out how to properly initialize visitor, and after a number of tries
				//I examined Rokas's code and discovered that I needed to set a string AND initialize add that
				//a new array in streams.users with that string as the key (the part I was missing).
				visitor = "you";
				streams.users[visitor] = [];
				
				
				//returns the jQuery object for a tweetle's HTML
				var createTweetle = function(index, user) {
					var tweetle = user ? streams.users[user][index] : streams.home[index];
					var $tweetle = $('<div class="tweetle">' +
									'<h6 class="timestamp clearfix" data-utc="' + tweetle.created_at + '">' + moment(tweetle.created_at).fromNow() + '</h6>' +
									'<h4 class="username">@' + tweetle.user + '</h4>' +
									'<p class ="message">' + tweetle.message + '</p></div>');
					
					return $tweetle;
				}
				
				//prints a single tweetle to the appropriate place in the DOM
				var printTweetle = function(keyword) {
					if (keyword === 'overlay') {
						var $tweetle = createTweetle(userPrinted, user);
						$tweetle.prependTo($('.second-feed'));
						$('.second-feed').find('.tweetle').slideDown(300);
						userPrinted++;
					} else {
						var $tweetle = createTweetle(printed);
						$tweetle.prependTo($('.feed'));
						$('.feed').find('.tweetle').slideDown(300);
						printed++;
					}
				}
				
				//prints tweetles every half second if refresh is true and there are tweetles to print
				var refreshTweetles = function(keyword) {
					if (keyword === 'overlay') {
						if (refresh &&  userPrinted <= streams.users[user].length - 1) {
							printTweetle(keyword);
						}
						overlayTimer = setTimeout(function() {refreshTweetles(keyword)}, 500);
					} else {
						if (refresh && printed <= streams.home.length -1) {
							printTweetle();
						}
						timer = setTimeout(function() {refreshTweetles()}, 500);
					}
				};
				
				//immediately prints all unprinted tweetles before resuming regular refreshes
				var fillTweetles = function(keyword) {	
					if (keyword === 'overlay') {
						while (userPrinted <= streams.users[user].length - 1) {
							printTweetle(keyword);
						}
					} else {
						while (printed <= streams.home.length - 1) {
							printTweetle();
						}
					}
					
					refreshTweetles(keyword);
				}
				
				//refreshes the timestamp on every tweetle every second
				var refreshTime = function() {
					$('.feed').find('.timestamp').each(function() {
						var utcTime = $(this).data("utc");
						$(this).text(moment(utcTime).fromNow());
					});
					
					$('.second-feed').find('.timestamp').each(function() {
						var utcTime = $(this).data("utc");
						$(this).text(moment(utcTime).fromNow());
					});
					
					setTimeout(refreshTime, 1000);
				}
				
				//allows the user to toggle tweetle refreshing
				$('.refresh').on('click', function() {
					refresh = !refresh;
					
					if (refresh){
						$(this).text('Stop Refresh');
						fillTweetles();
					} else {
						$(this).text('Refresh');
					}
				});
				
				//allows the user to send their own tweetle
				$('.send').on('click', function() {
					var messageBox = $(this).closest('.input').find('.user-message');
					var message = messageBox.val();
					if (message.length > 0) {
						writeTweet(message);
					}
					messageBox.val('');
					
					//makes written tweets immediately appear, regardless of whether refresh is on
					if (refresh) {
						printTweetle();
					} else {
						refresh = true;
						fillTweetles();
						refresh = false;
					}
				});
				
				//allows user to select individual usernames
				//special thanks to Travis for pointing out that I needed to call a static parent element here
				$('.feed').on('click', '.username', function() {
					user = $(this).text().slice(1);
					
					$('.second-heading').text("@" + user + "'s tweetles");
					$('.second-feed').children().remove();
					$('.secondary').slideDown(300);

					userPrinted = 0;
					fillTweetles('overlay');
				});
				
				$('.hide').on('click', function() {
					$(this).closest('.secondary').slideUp(300);
				});
				
				//main feed tweetle refresh will pause on mouseover to allow for easier interaction
				$('.feed').on('mouseenter', '.tweetle', function() {
					if(refresh) {
						refresh = false;
						paused = true;
					}
				});
				
				$('.feed').on('mouseleave', '.tweetle', function() {
					if (paused) {
						refresh = true;
						paused = false;
						fillTweetles();
					}
				});
				
				//initial call to begin loading tweetles and refreshing time
				fillTweetles();
				refreshTime();
			});
		</script>
	</body>
</html>
